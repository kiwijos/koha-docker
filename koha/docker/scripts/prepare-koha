#!/bin/bash

set -e

# Export variables (with defaults) to make them available to all child processes
export KOHA_INSTANCE=${KOHA_INSTANCE:-default}
export KOHA_INTRANET_PORT=${KOHA_INTRANET_PORT:-8080}
export KOHA_OPAC_PORT=${KOHA_OPAC_PORT:-8081}
export USE_MEMCACHED=${USE_MEMCACHED:-no}
export MYSQL_SERVER=${MYSQL_SERVER:-mariadb}
export MYSQL_PASSWORD=${MYSQL_PASSWORD:-$(pwgen -s 15 1)}
export ZEBRA_MARC_FORMAT=${ZEBRA_MARC_FORMAT:-marc21}
export MYSQL_ROOT_USER=${MYSQL_ROOT_USER:-root}

echo "Running startup script..."

# Fill in the values in our configuration file and write it to the place Koha reads it from
envsubst < /docker/config/koha-sites.conf > /etc/koha/koha-sites.conf

echo -n "${KOHA_INSTANCE}:koha_${KOHA_INSTANCE}:${MYSQL_PASSWORD}:koha_${KOHA_INSTANCE}:${MYSQL_SERVER}" > /etc/koha/passwd

# Use helper functions (if present), otherwise exit
if [ ! -f "/usr/share/koha/bin/koha-functions.sh" ]
then
    echo "koha-functions should be present" 1>&2
    exit 1
fi

source /usr/share/koha/bin/koha-functions.sh

if ! is_instance ${KOHA_INSTANCE} || [ ! -f "/etc/koha/sites/${KOHA_INSTANCE}/koha_conf.xml" ]
  then
      echo "Executing koha-create for instance ${KOHA_INSTANCE}"
      koha-create --use-db ${KOHA_INSTANCE} | true
  else
      echo "Creating directories structure"
      koha-create-dirs ${KOHA_INSTANCE}
fi

service apache2 stop

# Give the Koha instance user ownership of the log directory to avoid permission errors
chown -R ${KOHA_INSTANCE}-koha:${KOHA_INSTANCE}-koha /var/log/koha/${KOHA_INSTANCE}/

# Enable and start the Plack server for the Koha instance
koha-plack --enable ${KOHA_INSTANCE}
koha-plack --start ${KOHA_INSTANCE}

# Make sure the plack socket directory exists with proper permissions
if [ ! -d "/var/run/koha/${KOHA_INSTANCE}" ]; then
    mkdir -p /var/run/koha/${KOHA_INSTANCE}
    chown -R ${KOHA_INSTANCE}-koha:${KOHA_INSTANCE}-koha /var/run/koha/${KOHA_INSTANCE}
fi

# Wait a moment for Plack to initialize
sleep 2

# Start Apache in the foreground
apache2ctl -D FOREGROUND
